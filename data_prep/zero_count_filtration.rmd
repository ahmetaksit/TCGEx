---
title: "Zero Count Filtration Step"
author: "memrekus"
date: "2023-04-04"
output: html_document
---

```{r}


library(dplyr)

tcga_projects<-c("ACC","BLCA","CESC","CHOL","COAD",
                 "DLBC","ESCA","GBM","KICH","KIRP","LAML",
                 "LIHC","MESO","PAAD","PCPG","READ","TGCT",
                 "THYM","UCS","UVM","UCEC","THCA","STAD","SKCM","PRAD",
                 "OV","LUSC","LUAD","LGG","KIRC","HNSC","BRCA","SARC")

for(i in tcga_projects){
  
  data<-readRDS(paste0("projects/", i, ".rds"))
  
  without_metadata<-data %>% select(!starts_with("meta."))
  
  #if it is "SARC" you should discard âœ– These names are duplicated:
  #* "meta.leukocyte.fraction" at locations 103 and 113.
  # data$meta.leukocyte.fraction<-NULL
  
  metadata<-data %>% select(starts_with("meta."))
  
  gene_cols <- unlist(lapply(without_metadata, is.numeric))
  
  # Subset numeric columns of data (genes only)
  
  genes_data <- without_metadata[ , gene_cols]                        
  
  barcodes <- without_metadata[ , !gene_cols]
  
  names(barcodes) <- paste0("meta.", names(barcodes))
  
  
na_zero_percent <- apply(genes_data, 2, function(x) mean(is.na(x) | x == 0))

selected_columns <- names(genes_data)[na_zero_percent < 0.25]

# for (col in deleted_columns) {
#   if (sum(!is.na(genes_data[,col]) & genes_data[,col] != 0) < 50) {
#     genes_data[, col] <- NULL
#   } else {
#     selected_columns <- c(selected_columns, col)
#   }
# }

filtered_genes_data <- genes_data[, selected_columns]
  
filtered_data<-cbind.data.frame(filtered_genes_data, metadata, barcodes)
   
saveRDS(filtered_data,paste0("projects (filtered)/", i, ".rds"))

}

 # Turn the data to data.table

 library(data.table)
 # library(zstdlite)

for(i in tcga_projects){

 data_as_data_table<-readRDS(paste0("projects (filtered)/", i, ".rds"))

 data_as_data_table<-data.table(data_as_data_table)

 saveRDS(data_as_data_table,paste0("projects (filtered)/", i, ".rds"))
 
 # 
 # # Compression Step
 # 
 # compressed_filtered_data <- zstd_serialize(data_as_data_table, level = 22)
 # 
 # saveRDS(compressed_filtered_data, paste0("zero_count_filtrated_compressed/", i, ".rds"))
 # 
  }



```

